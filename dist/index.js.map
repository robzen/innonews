{"version":3,"sources":["../index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["require(\"babel-polyfill\");\r\nimport Koa from 'koa';\r\nimport send from 'koa-send';\r\nimport Router from 'koa-router';\r\nimport News from './news';\r\nimport ImageUtils from './image-utils';\r\nimport User from './user';\r\n\r\nconst app = new Koa();\r\nconst router = new Router();\r\nconst news = new News();\r\nconst imageUtils = new ImageUtils();\r\n\r\nconst port = 3000;\r\nconst ipUsers = [];\r\n\r\n//error handling\r\napp.use(async (ctx, next) => {\r\n\ttry {\r\n\t\tawait next();\r\n\t} catch(err) {\r\n\t\tctx.body = { message: err.message };\r\n\t\tctx.status = err.status || 500;\r\n\t}\r\n});\r\n\r\napp.use(router.routes());\r\n\r\nrouter.get('/:newsSource?/:newsSortBy?/:updateMinutes?', async (ctx) => {\r\n    //TODO: update images if settings have changed + change settings for existing users\r\n    //user handling\r\n    let ip = ctx.request.ip.replace(/\\W/g, '-');\r\n    let userAgent = ctx.headers['user-agent'];\r\n    console.log(`request: ${userAgent} - newsSource:${ctx.params.newsSource}, newsSortBy:${ctx.params.newsSortBy}, updateMinutes:${ctx.params.updateMinutes}`);\r\n    ctx.state.user = await getUser(ipUsers, ip, userAgent, {\r\n        newsSource: ctx.params.newsSource,\r\n        newsSortBy: ctx.params.newsSortBy,\r\n        updateMinutes: ctx.params.updateMinutes\r\n    });\r\n\r\n    await send(ctx, ctx.state.user.getNextImage());\r\n\r\n    //update news images if updateInterval time is reached\r\n    let updateInterval = ctx.state.user.getSettings().updateMinutes;\r\n    let lastUpdate = ctx.state.user.getLastUpdate();\r\n    if(lastUpdate + updateInterval*60*1000 <= Date.now()) {\r\n        getNewsImages(ctx.state.user);\r\n    }\r\n});\r\n\r\n//start server\r\napp.listen(port);\r\nconsole.log('listening on port '+port);\r\n\r\nconst getUser = async (users, ip, userAgent, givenSettings) => {\r\n    for(let i=0; i<users.length; i++) {\r\n        let existingUser = users[i];\r\n\r\n        if(existingUser.getIp() === ip) { return existingUser; }\r\n    }\r\n\r\n    //register new user and download news images\r\n    let newUser = new User(ip, userAgent);\r\n    newUser.setSettings(givenSettings);\r\n    users.push(newUser);\r\n    console.log(`new user registered: IP: ${ip}, Innovaphone Version: ${newUser.getInnovaphoneVersion()}, Settings: ${JSON.stringify(newUser.getSettings())}`);\r\n    await getNewsImages(newUser);\r\n\r\n    return newUser;\r\n};\r\n\r\nconst getNewsImages = async user => {\r\n    console.log('updating images for user: '+user.getIp());\r\n\r\n    return new Promise((resolve, reject) => {\r\n        news.get(user.getSettings().newsSource, user.getSettings().newsSortBy).then(newsResponse => {\r\n            let displaySettings = user.getDisplaySettings();\r\n\r\n            user.setLastUpdate(Date.now());\r\n            user.resetImages();\r\n\r\n            newsResponse.articles.forEach(function(article, i) {\r\n                if(article.urlToImage != null) { //only articles with images\r\n                    imageUtils.download(article.urlToImage, `images/${user.getIp()}/${i}`)\r\n                        .then(fileName => {\r\n                            //console.log(`image ${i} downloaded.`);\r\n                            return imageUtils.edit(fileName, displaySettings.width, displaySettings.height, displaySettings.paddingBottom, article.title);\r\n                        })\r\n                        .then((imgFile, promiseError) => {\r\n                            if(promiseError) {\r\n                                console.log('error while getting image', err);\r\n                            } else {\r\n                                console.log(`image ${imgFile} added.`);\r\n                                user.addImage(imgFile);\r\n                            }\r\n\r\n                            //check if done\r\n                            if(i+1 >= newsResponse.articles.length) {\r\n                                resolve();\r\n                            }\r\n                        }).catch(err => {\r\n                            reject('error while downloading news: '+err);\r\n                        })\r\n                } else {\r\n                    //check if done\r\n                    if(i+1 >= newsResponse.articles.length) {\r\n                        resolve();\r\n                    }\r\n                }\r\n            });\r\n        }).catch(err => {\r\n            reject('error while getting news: '+err);\r\n        });\r\n    });\r\n};"]}