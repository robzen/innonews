{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["require(\"babel-polyfill\");\r\nimport Koa from 'koa';\r\nimport send from 'koa-send';\r\nimport News from './news';\r\nimport ImageUtils from './image-utils';\r\nimport User from './user';\r\n\r\nconst app = new Koa();\r\nconst news = new News();\r\nconst imageUtils = new ImageUtils();\r\n\r\nconst port = 3000;\r\nconst ipUsers = [];\r\n\r\n//error handling\r\napp.use(async (ctx, next) => {\r\n\ttry {\r\n\t\tawait next();\r\n\t} catch(err) {\r\n\t\tctx.body = { message: err.message };\r\n\t\tctx.status = err.status || 500;\r\n\t}\r\n});\r\n\r\n//user handling\r\napp.use(async (ctx, next) => {\r\n    let ip = ctx.headers['host'].split(':')[0];\r\n    let userAgent = ctx.headers['user-agent'];\r\n\r\n    //TODO: apply settings provided via GET ?source=spiegel&update=5\r\n\r\n    ctx.state.user = await getUser(ipUsers, ip, userAgent);\r\n\r\n    await next();\r\n});\r\n\r\n//serving images\r\napp.use(async ctx => {\r\n    //update news images if updateInterval time is reached\r\n    let updateInterval = ctx.state.user.getSettings().updateMinutes;\r\n    let lastUpdate = ctx.state.user.getLastUpdate();\r\n    if(lastUpdate + updateInterval*60*1000 <= Date.now()) {\r\n        await getNewsImages(ctx.state.user);\r\n    }\r\n\r\n    await send(ctx, ctx.state.user.getNextImage());\r\n});\r\n\r\n//start server\r\napp.listen(3000);\r\nconsole.log('listening on port '+port);\r\n\r\n\r\nconst getUser = async (users, ip, userAgent) => {\r\n    for(let i=0; i<users.length; i++) {\r\n        let existingUser = users[i];\r\n\r\n        if(existingUser.getIp() === ip) { return existingUser; }\r\n    }\r\n\r\n    let newUser = new User(ip, userAgent);\r\n    users.push(newUser);\r\n    await getNewsImages(newUser);\r\n    console.log(`new user registered: IP: ${ip}, Innovaphone Version: ${newUser.getInnovaphoneVersion()}`);\r\n\r\n    return newUser;\r\n};\r\n\r\nconst getNewsImages = async user => {\r\n    console.log('updating images for user: '+user.getIp());\r\n\r\n    return new Promise((resolve, reject) => {\r\n        news.get(user.getSettings().newsSource, 'top').then(newsResponse => {\r\n            let displaySize = user.getDisplaySize();\r\n\r\n            user.setLastUpdate(Date.now());\r\n            user.resetImages();\r\n\r\n            newsResponse.articles.forEach(function(article, i) {\r\n                if(article.urlToImage != null) { //only articles with images\r\n                    imageUtils.download(article.urlToImage, `images/${user.getIp()}/${i}`)\r\n                        .then(fileName => {\r\n                            //console.log(`image ${i} downloaded.`);\r\n                            return imageUtils.edit(fileName, displaySize.width, displaySize.height, article.title);\r\n                        })\r\n                        .then((imgFile, promiseError) => {\r\n                            if(promiseError) {\r\n                                console.log('error while getting image', err);\r\n                            } else {\r\n                                //console.log(`image ${imgFile} edited.`);\r\n                                user.addImage(imgFile);\r\n                            }\r\n\r\n                            //check if done\r\n                            if(i+1 >= newsResponse.articles.length) {\r\n                                resolve();\r\n                            }\r\n                        });\r\n                } else {\r\n                    //check if done\r\n                    if(i+1 >= newsResponse.articles.length) {\r\n                        resolve();\r\n                    }\r\n                }\r\n            });\r\n        }).catch(err => {\r\n            reject('error while getting news: '+err);\r\n        });\r\n    });\r\n};"]}